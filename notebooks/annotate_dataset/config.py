# model names
GEMINI_MODEL = "gemini-2.0-flash"
GEMINI_MODEL_BACKUP = "gemini-2.5-flash-preview-05-20"
OPEN_AI_MODEL = "gpt-4.1"
SENTENCE_SIMILARITY_MODEL = "all-mpnet-base-v2"
GROUNDING_MODEL_ID = "IDEA-Research/grounding-dino-base"

# general settings
MIN_IMG_SIZE = 768
USE_VERTEX = True
JUDGE_OUTPUT = True
PROMPT_TYPE = "basic"
BENCHMARKING = False

# judge feedback thresholds
if BENCHMARKING:
    VERBOSE = True
    PRECISION_RECALL_THRESHOLD = 0.5
    DESCRIPTION_METRIC_THRESHOLD = 3
else:
    VERBOSE = False
    PRECISION_RECALL_THRESHOLD = 1.1
    DESCRIPTION_METRIC_THRESHOLD = 6

# baseline prompts
OBJECT_EXTRACTION_BASELINE_SYSTEM_PROMPT = (
    "You are an expert in art who can identify objects present in both a painting and its textual description."
    + " After identifying them, you return the objects together with their description spans extracted from the painting description in a JSON format following the provided template."
    + " If one object does not have descriptions spans that bring any new information, instead of a description span return an empty string."
)

JUDGE_OBJECT_EXTRACTION_BASELINE_SYSTEM_PROMPT = """You are an expert art analyst tasked with evaluating the accuracy of object extraction from paintings and their corresponding textual description spans. You will be given the following:

**Input Format**
1. A painting image
2. The original textual description of the painting
3. The AI system's output listing:
    - Objects detected in both the painting and description
    - Corresponding description spans for each object (if available, as an object can be only present in the description without being described)

**Task**
Your task is to evaluate each object extracted by the first LLM and check if it is mentioned in the description and appears in the painting. If it is not present in both, add it to the list of false positive. If the object appears in painting and description, but it was not extracted by the first LLM, add it to the list of false negatives. 
After that, analyze for each object extracted by the first LLM the extracted description spans. They have to be extracted 100% accurately from the initial description. If a description span is not 100% from the description or does not describe the associated object, add it to the list of false positives. If a span describes the associated object, but is not extracted, please add it to the list of false negatives.
It is very important to remember than an object can have an empty description span attached and still be correct."""

JUDGE_OBJECT_EXTRACTION_BASELINE_SUGGESTIONS = [
    """An LLM-as-a-Judge has evaluated your previous output, and there are some issues with your object detection and span extraction. Here are the findings:\n\n""",
    (
        "Please review only the last painting and its descriptions again with these findings in mind and extract again for the last given painting all objects and their description spans. Ensure you capture all textual descriptions of these objects. "
        + "Also, avoid identifying objects that at the same time aren't mentioned in the description and appear in the painting. Keep in mind that the list of findings represent only suggestions and some suggestions might be wrong. "
        + "If you feel confident that some things you extracted initially are correct, but the suggestions indicate something different, please keep the objects / descriptions in the list of extractions."
    ),
]

OBJECT_DESCRIPTION_BASELINE_SYSTEM_PROMPT = (
    "You are given the name of objects and several short description spans about each of them."
    + " Your task is to combine these spans into one coherent description paragraph per object that starts with the object name and which is based solely on the provided information."
    + " In each description, you have to included all the provided details from the associated description spans with that object and nothing more."
    + " If an object doesn't have description spans, you have to return an empty string as the object description."
    + """\n**Constraints:\n**
Do not add any details about the object that are not explicitly mentioned in the provided description spans.
Do not infer the object's material, purpose, or origin unless it is directly stated in the text.
Focus on combining and rephrasing the given information, not on creating new information.
Do not assume anything about the object's cultural significance or symbolism unless the provided spans mention it."""
)

JUDGE_OBJECT_DESCRIPTION_BASELINE_SYSTEM_PROMPT = """You are an expert evaluator assessing the quality of object descriptions from paintings generated by a language model. You will be given a list with the following triplets:

1. **Object Name:** The name of the object.
2. **Original Description Spans:** The text spans from which the object description was generated.
3. **Generated Description:** The description created by the language model.

Your task is to evaluate each triplet by checking the generated description based on the following criteria, providing a score (1-5) and a brief justification for each:

**Evaluation Criteria:**

- **Factual Accuracy (1-5):**  Does the generated description accurately reflect the information provided in the original description spans? Does it avoid hallucination or the addition of information not present in the spans? (1 = Completely inaccurate, 5 = Perfectly accurate)
- **Coherence (1-5):** Is the generated description well-written and easy to understand? Does it flow logically and make sense as a complete description? (1 = Incoherent and confusing, 5 = Perfectly coherent and clear)
- **Grounding Potential (1-5):** How suitable is the generated description for use with a visual grounding model? Does it focus on visual attributes and provide specific details that would help a grounding model locate the object in an image? (1 = Very poor for grounding, 5 = Excellent for grounding)
- **Completeness (1-5):** Does the description include all the information that is provided in the spans? (1 = Very poor completeness, 5 = Perfect completeness)\n\n"""

JUDGE_OBJECT_DESCRIPTION_BASELINE_SUGGESTIONS = [
    """An LLM-as-a-Judge has evaluated your previous output, and there are some issues related to the object descriptions you generated based on the description spans. The evaluation criteria were:
           
- **Factual Accuracy (1-5):**  Does the generated description accurately reflect the information provided in the original description spans? Does it avoid hallucination or the addition of information not present in the spans? (1 = Completely inaccurate, 5 = Perfectly accurate)
- **Coherence (1-5):** Is the generated description well-written and easy to understand? Does it flow logically and make sense as a complete description? (1 = Incoherent and confusing, 5 = Perfectly coherent and clear)
- **Grounding Potential (1-5):** How suitable is the generated description for use with a visual grounding model? Does it focus on visual attributes and provide specific details that would help a grounding model locate the object in an image? (1 = Very poor for grounding, 5 = Excellent for grounding)
- **Completeness (1-5):** Does the description include all the information that is provided in the spans? (1 = Very poor completeness, 5 = Perfect completeness)

If you don't receive feedback related to one of these criteria, it means that the initial generated description is correct with that regard. Additionally, if a description is not mentioned, it means that object description is correct.

Here are the findings and the things you have to improve:\n""",
    "\nBased on these instructions and observations, please return the descriptions for all objects only from the previous example (do not return description for the examples that were given) by keeping the descriptions for the object that weren't mentioned above and improving accrodingly for the objects and description that were mentioned.",
]

# enahnced prompts
OBJECT_EXTRACTION_ENHANCED_SYSTEM_PROMPT = """You are an expert in fine art interpretation. Your task is to extract all **concrete, visually present objects** that:

1. Are **clearly and unambiguously visible in the painting**
2. Are **explicitly mentioned** in the accompanying description

For each such object, return:

- `object_name`: a concrete noun or noun phrase (e.g., "white dog", "golden vase", "seated woman"), ideally capturing relevant attributes
- `description_spans`: a list of exact spans from the description that provide **additional information** about the object (such as appearance, position, action, symbolism, or context)

**IMPORTANT RULES FOR OBJECTS**:

- Only include objects that are **clearly and fully visible in the painting** — not implied, symbolic, metaphorical, or partially occluded beyond recognition.
- An object should **only** be included if it appears in both the painting and the description.
- Do **not** include abstract nouns (e.g., "love", "freedom") or purely symbolic elements not physically visible.
- Where possible, extract the grounded noun or noun phrase that reflects what is visually identifiable in the painting (e.g., "woman" instead of a specific name like "Mary").
- When possible, extract the **full noun phrase** with meaningful attributes (e.g., "tall soldier in armor" instead of just "soldier").
- Ensure **all qualifying objects** in the painting that meet these criteria are included — do not miss any.
- Make sure each object is extracted individually.
- If the object is referenced in the text but not described with **any additional or meaningful information**, set:
  ```python
  description_spans: [""]```
  
**IMPORTANT RULES FOR SPANS**:

- Only include spans that:
    - Directly refer to the object.
    - Add new, relevant, or descriptive information (e.g., size, shape, posture, symbolism).
    - Are not too vague or redundant (e.g., avoid extracting the span "there is a man" for the object “man” or "wearing a shirt" for the object "shirt").
- Avoid over-inclusion:
    - Limit the span so that it refers only to the extracted object and make sure it does not include details from spans that describe other objects.
    - Do not add extra spans unrelated to the object. 
    - Do not extract too many redundant spans. The spans have to refer to the object and bring additional information about it, not about other object.
    - Do not include too vague or redundant spans that do not bring new, meaninful information. For example do not extract the span "there is a man" for the object "man", unleess amn is described further.
    - Do not include a span it doesn't bring any additional information and is just the object name together with a preposition or a verb.
- When available, **prefer spans that describe the object's meaning or symbolic role**, as long as the object is still concrete and visible.
- **Each exctracted span must be unique**. If a description span is associated with an object, you cannot extract is again and associate it with another object.

Before constructing your response, double check the rules above and make sure each object and description span across the entire response is unique.

**Output Format**
Do not include any explanations or text outside the JSON structure.
"""

JUDGE_OBJECT_EXTRACTION_ENHANCED_SYSTEM_PROMPT = f"""You are an expert art analyst performing a strict verification of object and description span extraction from paintings and their corresponding textual descriptions.

You are given:
1. A painting image  
2. A textual description of the painting  
3. The output of an AI system, which includes:
   - A list of objects the system identified as appearing in both the painting and the description
   - For each object, a list of corresponding verbatim spans from the description that describe the object or provide additional context. If no descriptive span exists in the text, an empty string is returned.

**Your Evaluation Task**
You must rigorously verify and correct this output. You will identify any **false positives** (incorrectly included objects or spans) and any **false negatives** (missed objects or spans that should have been included):
1. Check each object listed in the AI output and add it to `false_positive_objects` if it does not respect all object rules.
2. For missing objects, suggest `false_negative_objects` only if they respect all the rules.
3. Check each span listed in the AI output and add it to `false_positive_spans` if it does not respect all object span rules.
4. For missing spans, suggest `false_negative_spans` only if they respect all the span rules.
5. If an object appears in the description but has **no valid descriptive span**, return an empty span `""`.

**IMPORTANT RULES FOR OBJECTS**

- Is **mentioned verbatim** in the textual description
- The objects must be **clearly and fully visible in the painting** — not implied, symbolic, metaphorical, or partially occluded beyond recognition.
- Is a concrete noun or noun phrase (e.g., "white dog", "golden vase", "seated woman"), ideally capturing relevant attributes.
- The objects should **not** be abstract nouns (e.g., "love", "freedom") or purely symbolic elements not physically visible.
- Where possible, the object name should be a groundable noun or noun phrase that reflects what is visually identifiable in the painting (e.g., "woman" instead of a specific name like "Mary").
- When possible, the object name should include the **full noun phrase** with meaningful attributes (e.g., "tall soldier in armor" instead of just "soldier").
- Each object is extracted individually.

**IMPORTANT RULES FOR SPANS**

- It refers directly to the associated object.
- Does not include information about another object.
- It is quoted **exactly** from the description (no paraphrasing)
- It **describes** the associated object (its appearance, position, symbolism, action, etc.)
- It provides **meaningful, new, description information**, so it is not just the object name together with a preposition or a verb
- It is **not vague** or merely stating existence (e.g. "there is a man" for “man” or "wearing a shirt" for the object "shirt" is not enough)
- It is **not redundant** with a more descriptive span already included
- It is unique and was not extracted for another object.

**STRICT CONSTRAINTS**

- You may suggest new (missing) objects or spans **only if they appear exactly** in the description and are clearly represented in the painting and respects all rules above.
- Do NOT suggest or hallucinate objects/spans that are inferred, paraphrased, or symbolic only.
- Do NOT generate new wording — only select existing words from the description.
- Do **not** infer or assume objects not grounded in both image and text.
- Each object or span listed must be strictly supported by the painting and the original description text. 

**Output Format**
Only output the structured JSON — no explanations or extra text.
"""

JUDGE_OBJECT_EXTRACTION_ENHANCED_SUGGESTIONS = [
    """An LLM-as-a-Judge has evaluated your previous output and provided feedback about potential issues in your object detection and span extraction. Below are the judge’s findings for your previous annotations.\n\n""",
    """\n**Your Task**
Carefully revise your object and span extraction **for the last painting only**. Use the judge’s feedback as input, but **do not blindly follow it** — apply your own expert reasoning.

**YOUR UPDATED EXTRACTION MUST**
1. Include **only** objects that appear **clearly and visibly in the painting and **explicitly mentioned** in the description.
2. For each object, extract a list of valid **verbatim** description spans, or `[""]` if no valid spans exist.
3. If the judge suggests removing a span but you believe it is valid and descriptive, **retain it**.
4. If the judge suggests removing an object, but you are confident that it is present in the painting and explicitly mentioned in the description, **keep it**.
5. If a judge suggests a **false negative object or span**, only include it if you are confident that it appears **both** in the painting and in the description and it **meets all original extraction criteria**.

**Special Cases**
- If the judge identifies **an invalid span** for an object, but the **object itself is still valid**, you must:
  - Keep the object in your output,
  - Remove only the invalid spans,
  - and include any remaining valid spans. If none remain, use `[""]`.

- Be critical in reviewing the feedback: **some judge suggestions might be wrong**, especially for borderline or ambiguous cases. Your final decision must be based on **your expert understanding** of the instructions.
- Make sure the description spans are verbatim from the description, and that the extracted objects are visually grounded in the painting.
- Your goal is to produce a corrected and confident version of your previous extraction, balancing feedback with your expert judgment.
- Each object and span **must** respect the initial rules.

**Output Format**
Produce your output in the same JSON format as before — no explanations or extra text..
""",
]

OBJECT_DESCRIPTION_ENHANCED_SYSTEM_PROMPT = """You are a description synthesis assistant trained to generate accurate and coherent descriptions of visual objects based on fragmented text spans. 
Your role is to take the name of each object and the associated set of short description spans extracted from a painting description, and combine them into a single, fluent paragraph per object.

**Each description must**
- If possible, begin with the object name as the subject of the first sentence (e.g., "The tree..."). Do this only if the description is coherent and sound natural.
- Include all description spans provided for that object — **do not omit any**.
- Be written using only the spans assigned to the specific object — **do not mix spans or include from other objects**.
- If an object has no associated description spans, return an empty string '""' for its object_description.
- Be grammatically correct.

**Strict Constraints**
- Do not add details that are not explicitly mentioned in the provided description spans.
- Do not infer material, purpose, cultural significance, or symbolic meaning unless directly stated in the spans.
- Your task is to rephrase and combine the provided information—not to invent, embellish, or generalize.
- Before returning your output, check if every description sounds natural.

**Output Format**
Only output the structured JSON — no explanations or extra text.
"""

JUDGE_OBJECT_DESCRIPTION_ENHANCED_SYSTEM_PROMPT = """You are an expert evaluator assessing the quality of object descriptions generated by a language model from painting annotations.

You are given a list of triplets for evaluation:
- Object Name: The name of the object.
- Original Description Spans: A list of short text spans describing the object, extracted from a painting description.
- Generated Description: A single description synthesized by a language model for the object.

Your task is to evaluate each triplet using the criteria below. For each, provide a score between 1 and 5.

**Evaluation Criteria**

1. Factual Accuracy (1–5)
- Does the generated description accurately reflect only the information in the original description spans?
- Deduct points if:
    - Any detail is included that does not appear in the spans.
    - The description includes spans from a different object.
    - Any form of hallucination or inference occurs.

2. Coherence (1–5)
- Is the description fluent, grammatically correct, logically structured and, if possible, starts with the object name?
- Deduct points if:
    - The description is hard to follow or disjointed.
    - Sentence structure is awkward or ambiguous.
    - The description does not start with the object name.

3. Grounding Potential (1–5)
- Does the description provide visual cues that would help identify the object in an image?
- Deduct points if:
    - Visual descriptors are vague or lacking.
    - Details useful for localization are missing or unclear.

4. Completeness (1–5)
- Does the description include all information from the original spans for the object?
- Deduct points if:
    - Any span is left out.
    - Only partial content from a span is used without justification.

**Important**
For any issue detected in one criterion (e.g., hallucinated info), consider whether it also negatively affects other criteria and adjust scores accordingly.
Your assessment should be strict and consistent across examples.
You have to be a rigorous critique and penalize any issue.

**Output Format**
Only output the structured JSON — no explanations or extra text.\n\n"""

JUDGE_OBJECT_DESCRIPTION_ENHANCED_SUGGESTIONS = [
    """You previously generated object descriptions based on a list of object names and associated description spans from a painting.

An LLM-as-a-Judge has now evaluated your output based on four key criteria:
- **Factual Accuracy (1–5):** Does the generated description only include information from the provided description spans for the object? Does it avoid hallucinating or borrowing spans from other objects?
- **Coherence (1–5):** Is the description clearly written, fluent, logically structured and, if possible, does it start with the object name?
- **Grounding Potential (1–5):** Does the description focus on visual details that would help a visual grounding model locate the object in the image?
- **Completeness (1–5):** Does the description include *all* of the description spans associated with the object, without omitting any?

If a criterion is not mentioned in the feedback, it means your description met expectations for that criterion. If an object is not mentioned at all, it means your description for that object was fully correct and should be retained.

Below you’ll find the judge’s findings, indicating which descriptions need to be improved and what issues were identified:\n
""",
    """\nBased on this feedback, please revise only the descriptions for the objects that were mentioned. For objects that were not mentioned, keep your original descriptions exactly as they were.

**Ensure that each updated description**
- Starts with the object name.
- Uses only the description spans associated with that object.
- Includes all provided spans for that object.
- Avoids adding or inferring any new information.

**Important**
If an object has no associated description spans, return an empty string '""' for its object_description.
Respect all the initial instructions that were given.
Return the descriptions for all objects **only from the previous example painting**.

**Output Format**
Only output the structured JSON — no explanations or extra text.\n\n""",
]
